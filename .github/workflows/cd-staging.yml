name: CD - Deploy to STAGING

on:
  push:
    branches: ["staging"]
    paths:
      - 'ai_tutor_backend/**'
      - 'ai_tutor_app/**'
      - 'k8s/staging/**'
  workflow_dispatch:  # Manual trigger

env:
  DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}
  BACKEND_IMAGE: sang5664/ai-tutor-backend
  FRONTEND_IMAGE: sang5664/ai-tutor-frontend
  K8S_NAMESPACE: ai-tutor-staging

jobs:
  # ========================================
  # JOB 1: Build vÃ  Push Backend Image
  # ========================================
  build-backend:
    name: ğŸ”§ Build Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.BACKEND_IMAGE }}
          tags: |
            type=sha,prefix=staging-
            type=raw,value=staging-latest

      - name: ğŸ—ï¸ Build and Push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./ai_tutor_backend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # ========================================
  # JOB 2: Build vÃ  Push Frontend Image
  # ========================================
  build-frontend:
    name: ğŸ¨ Build Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.FRONTEND_IMAGE }}
          tags: |
            type=sha,prefix=staging-
            type=raw,value=staging-latest

      - name: ğŸ—ï¸ Build and Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./ai_tutor_app
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # ========================================
  # JOB 3: Deploy to K3s STAGING
  # ========================================
  deploy:
    name: ğŸš€ Deploy to K3s STAGING
    runs-on: self-hosted  # Use self-hosted runner on K3s server
    needs: [build-backend, build-frontend]
    environment: staging  # Require approval for staging
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ï¿½ Deploy to K3s STAGING (Direct)
        run: |
          set -e
          
          echo "ğŸ“¦ Applying K8s manifests..."
          kubectl apply -f k8s/staging/namespace/
          kubectl apply -f k8s/staging/mongodb/
          kubectl apply -f k8s/staging/backend/
          kubectl apply -f k8s/staging/frontend/
          
          echo "ğŸ”„ Updating images with commit SHA..."
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          kubectl set image deployment/backend backend=${{ env.BACKEND_IMAGE }}:staging-${SHORT_SHA} -n ${{ env.K8S_NAMESPACE }}
          kubectl set image deployment/frontend frontend=${{ env.FRONTEND_IMAGE }}:staging-${SHORT_SHA} -n ${{ env.K8S_NAMESPACE }}
          
          echo "â³ Waiting for rollout..."
          kubectl rollout status deployment/backend -n ${{ env.K8S_NAMESPACE }} --timeout=180s
          kubectl rollout status deployment/frontend -n ${{ env.K8S_NAMESPACE }} --timeout=180s
          
          echo "âœ… STAGING Deployment complete!"
          kubectl get pods -n ${{ env.K8S_NAMESPACE }}

      - name: ğŸ¥ Smoke Test
        run: |
          echo "â³ Waiting 15s for services to stabilize..."
          sleep 15
          
          # Test backend health endpoint
          BACKEND_POD=$(kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app=backend -o jsonpath='{.items[0].metadata.name}')
          echo "ğŸ” Testing backend pod: $BACKEND_POD"
          
          kubectl exec -n ${{ env.K8S_NAMESPACE }} $BACKEND_POD -- wget -q -O- http://127.0.0.1:5000/health || {
            echo "âŒ Backend health check failed!"
            exit 1
          }
          
          # Test a sample API endpoint
          kubectl exec -n ${{ env.K8S_NAMESPACE }} $BACKEND_POD -- wget -q -O- http://127.0.0.1:5000/api/subjects | grep -q "\[\]" || {
            echo "âŒ API endpoint test failed!"
            exit 1
          }
          
          echo "âœ… All smoke tests passed!"

      - name: ğŸ“Š Deployment Summary
        if: always()
        run: |
          echo "ğŸ“‹ STAGING Deployment Summary:"
          echo "----------------------------"
          kubectl get deployments -n ${{ env.K8S_NAMESPACE }}
          kubectl get pods -n ${{ env.K8S_NAMESPACE }}
          kubectl get svc -n ${{ env.K8S_NAMESPACE }}
