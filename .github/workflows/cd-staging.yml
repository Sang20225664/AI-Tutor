name: CD - Deploy to STAGING

on:
  push:
    branches: ["staging"]
    paths:
      - 'ai_tutor_backend/**'
      - 'ai_tutor_app/**'
      - 'k8s/staging/**'
  workflow_dispatch:  # Manual trigger

env:
  DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}
  BACKEND_IMAGE: sang5664/ai-tutor-backend
  FRONTEND_IMAGE: sang5664/ai-tutor-frontend
  K8S_NAMESPACE: ai-tutor-staging

jobs:
  # ========================================
  # JOB 1: Build vÃ  Push Backend Image
  # ========================================
  build-backend:
    name: ğŸ”§ Build Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.BACKEND_IMAGE }}
          tags: |
            type=sha,prefix=staging-
            type=raw,value=staging-latest

      - name: ğŸ—ï¸ Build and Push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./ai_tutor_backend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # ========================================
  # JOB 2: Build vÃ  Push Frontend Image
  # ========================================
  build-frontend:
    name: ğŸ¨ Build Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.FRONTEND_IMAGE }}
          tags: |
            type=sha,prefix=staging-
            type=raw,value=staging-latest

      - name: ğŸ—ï¸ Build and Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./ai_tutor_app
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # ========================================
  # JOB 3: Deploy to K3s STAGING
  # ========================================
  deploy:
    name: ğŸš€ Deploy to K3s STAGING
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    environment: staging  # Require approval for staging
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.K3S_SSH_KEY }}" > ~/.ssh/k3s_key
          chmod 600 ~/.ssh/k3s_key
          
          # Debug: Kiá»ƒm tra secret key cÃ³ há»£p lá»‡ khÃ´ng
          echo "ğŸ” Checking SSH key validity..."
          echo "Key file size: $(wc -c < ~/.ssh/k3s_key) bytes"
          echo "Key first line: $(head -n1 ~/.ssh/k3s_key)"
          echo "Key last line: $(tail -n1 ~/.ssh/k3s_key)"
          echo "Key fingerprint:"
          ssh-keygen -l -f ~/.ssh/k3s_key || echo "âŒ Invalid key format!"
          
          ssh-keyscan -H ${{ secrets.K3S_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: ğŸ“‹ Copy K8s manifests to server
        run: |
          scp -i ~/.ssh/k3s_key -r k8s/staging/* ${{ secrets.K3S_USER }}@${{ secrets.K3S_HOST }}:/tmp/k8s-staging/

      - name: ğŸš€ Deploy to K3s
        run: |
          ssh -i ~/.ssh/k3s_key ${{ secrets.K3S_USER }}@${{ secrets.K3S_HOST }} << 'DEPLOY_SCRIPT'
            set -e
            
            echo "ğŸ“¦ Applying K8s manifests..."
            kubectl apply -f /tmp/k8s-staging/namespace/
            kubectl apply -f /tmp/k8s-staging/mongodb/
            kubectl apply -f /tmp/k8s-staging/backend/
            kubectl apply -f /tmp/k8s-staging/frontend/
            
            echo "ğŸ”„ Updating images with commit SHA..."
            IMAGE_TAG="staging-${{ github.sha }}"
            kubectl set image deployment/backend backend=${{ env.BACKEND_IMAGE }}:${IMAGE_TAG:0:19} -n ${{ env.K8S_NAMESPACE }}
            kubectl set image deployment/frontend frontend=${{ env.FRONTEND_IMAGE }}:${IMAGE_TAG:0:19} -n ${{ env.K8S_NAMESPACE }}
            
            echo "â³ Waiting for rollout..."
            kubectl rollout status deployment/backend -n ${{ env.K8S_NAMESPACE }} --timeout=180s
            kubectl rollout status deployment/frontend -n ${{ env.K8S_NAMESPACE }} --timeout=180s
            
            echo "âœ… STAGING Deployment complete!"
            kubectl get pods -n ${{ env.K8S_NAMESPACE }}
            
            # Cleanup
            rm -rf /tmp/k8s-staging/
          DEPLOY_SCRIPT

      - name: ğŸ§¹ Cleanup SSH Key
        if: always()
        run: rm -f ~/.ssh/k3s_key
