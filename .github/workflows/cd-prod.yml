name: CD - Deploy to PRODUCTION

on:
  push:
    branches: ["main"]
    paths:
      - 'ai_tutor_backend/**'
      - 'ai_tutor_app/**'
      - 'k8s/prod/**'
  release:
    types: [published]
  workflow_dispatch:  # Manual trigger

env:
  DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}
  BACKEND_IMAGE: sang5664/ai-tutor-backend
  FRONTEND_IMAGE: sang5664/ai-tutor-frontend
  K8S_NAMESPACE: ai-tutor-prod

jobs:
  # ========================================
  # JOB 1: Build v√† Push Backend Image
  # ========================================
  build-backend:
    name: üîß Build Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîë Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: üè∑Ô∏è Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.BACKEND_IMAGE }}
          tags: |
            type=sha,prefix=prod-
            type=raw,value=prod-latest
            type=semver,pattern={{version}},enable=${{ github.event_name == 'release' }}

      - name: üèóÔ∏è Build and Push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./ai_tutor_backend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # ========================================
  # JOB 2: Build v√† Push Frontend Image
  # ========================================
  build-frontend:
    name: üé® Build Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîë Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: üè∑Ô∏è Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.FRONTEND_IMAGE }}
          tags: |
            type=sha,prefix=prod-
            type=raw,value=prod-latest
            type=semver,pattern={{version}},enable=${{ github.event_name == 'release' }}

      - name: üèóÔ∏è Build and Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./ai_tutor_app
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # ========================================
  # JOB 3: Deploy to K3s PRODUCTION
  # ========================================
  deploy:
    name: üöÄ Deploy to K3s PRODUCTION
    runs-on: self-hosted  # Use self-hosted runner on K3s server
    needs: [build-backend, build-frontend]
    environment: production  # REQUIRE MANUAL APPROVAL
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: ‚ö†Ô∏è Production Deployment Notice
        run: |
          echo "=============================================="
          echo "üö® PRODUCTION DEPLOYMENT"
          echo "=============================================="
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo "Event: ${{ github.event_name }}"
          echo "=============================================="

      - name:  Deploy to K3s PRODUCTION (Direct)
        run: |
          set -e
          
          echo "üì¶ Applying K8s manifests..."
          kubectl apply -f k8s/prod/namespace/
          kubectl apply -f k8s/prod/mongodb/
          kubectl apply -f k8s/prod/backend/
          kubectl apply -f k8s/prod/frontend/
          
          echo "üîÑ Updating images with commit SHA..."
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          kubectl set image deployment/backend backend=${{ env.BACKEND_IMAGE }}:prod-${SHORT_SHA} -n ${{ env.K8S_NAMESPACE }}
          kubectl set image deployment/frontend frontend=${{ env.FRONTEND_IMAGE }}:prod-${SHORT_SHA} -n ${{ env.K8S_NAMESPACE }}
          
          echo "‚è≥ Waiting for rollout..."
          kubectl rollout status deployment/backend -n ${{ env.K8S_NAMESPACE }} --timeout=300s
          kubectl rollout status deployment/frontend -n ${{ env.K8S_NAMESPACE }} --timeout=300s
          
          echo "‚úÖ PRODUCTION Deployment complete!"
          kubectl get pods -n ${{ env.K8S_NAMESPACE }}

      - name: üè• Production Smoke Test
        id: smoke_test
        run: |
          echo "‚è≥ Waiting 20s for production services to stabilize..."
          sleep 20
          
          # Test backend health endpoint
          BACKEND_POD=$(kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app=backend -o jsonpath='{.items[0].metadata.name}')
          echo "üîç Testing backend pod: $BACKEND_POD"
          
          # Critical health check
          kubectl exec -n ${{ env.K8S_NAMESPACE }} $BACKEND_POD -- wget -q -O- http://127.0.0.1:5000/health || {
            echo "‚ùå Backend health check failed!"
            echo "smoke_test_failed=true" >> $GITHUB_OUTPUT
            exit 1
          }
          
          # Test database connectivity
          kubectl exec -n ${{ env.K8S_NAMESPACE }} $BACKEND_POD -- wget -q -O- http://127.0.0.1:5000/api/subjects | grep -q "\[\]" || {
            echo "‚ùå Database connectivity test failed!"
            echo "smoke_test_failed=true" >> $GITHUB_OUTPUT
            exit 1
          }
          
          echo "‚úÖ All production smoke tests passed!"
          echo "smoke_test_failed=false" >> $GITHUB_OUTPUT

      - name: ÔøΩ Auto Rollback on Failure
        if: failure() && steps.smoke_test.outputs.smoke_test_failed == 'true'
        run: |
          echo "üö® Smoke test failed! Rolling back to previous version..."
          
          # Rollback backend and frontend deployments
          kubectl rollout undo deployment/backend -n ${{ env.K8S_NAMESPACE }}
          kubectl rollout undo deployment/frontend -n ${{ env.K8S_NAMESPACE }}
          
          echo "‚è≥ Waiting for rollback to complete..."
          kubectl rollout status deployment/backend -n ${{ env.K8S_NAMESPACE }} --timeout=180s
          kubectl rollout status deployment/frontend -n ${{ env.K8S_NAMESPACE }} --timeout=180s
          
          echo "‚úÖ Rollback completed successfully!"
          kubectl get pods -n ${{ env.K8S_NAMESPACE }}

      - name: ÔøΩüìä Deployment Summary
        if: success()
        run: |
          echo "=============================================="
          echo "‚úÖ PRODUCTION DEPLOYMENT SUCCESSFUL"
          echo "=============================================="
          echo "Backend: ${{ env.BACKEND_IMAGE }}:prod-${{ github.sha }}"
          echo "Frontend: ${{ env.FRONTEND_IMAGE }}:prod-${{ github.sha }}"
          echo "Namespace: ${{ env.K8S_NAMESPACE }}"
          echo "=============================================="

      - name: ‚ùå Rollback Summary
        if: failure()
        run: |
          echo "=============================================="
          echo "‚ùå DEPLOYMENT FAILED - ROLLBACK EXECUTED"
          echo "=============================================="
          echo "Please check logs and fix issues before redeploying"
          kubectl get pods -n ${{ env.K8S_NAMESPACE }}
          kubectl describe pods -n ${{ env.K8S_NAMESPACE }}
          echo "=============================================="
